name: CI/CD Auto Pull and Rebuild

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  royalbakery-agatha:
    runs-on: self-hosted

    steps:
    - name: Set project path
      run: |
        PROJECT_PATH="/mnt/c/royalbakery"
        if [ ! -d "$PROJECT_PATH" ]; then
          echo "❌ Error: Folder /mnt/c/royalbakery tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "✅ Found project at: $PROJECT_PATH"

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin main
        git reset --hard origin/main

    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true

    - name: Cleanup container & network conflicts
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker rm -f royalbakery-mysql-1 || true
        docker network rm royalbakery_default || true
        docker network rm royalbakery_app-network || true

    - name: Remove old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        sleep 30
        docker compose ps

    - name: Health check
      run: |
        curl -f http://localhost:8080 || exit 1

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ Deployment berhasil di laptop-agatha!"
        else
          echo "❌ Deployment gagal di laptop-agatha!"
        fi

  royalbakery-najmira:
    runs-on: self-hosted

    steps:
    - name: Set project path
      run: |
        PROJECT_PATH="/mnt/c/royalbakery"
        if [ ! -d "$PROJECT_PATH" ]; then
          echo "❌ Error: Folder /mnt/c/royalbakery tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "✅ Found project at: $PROJECT_PATH"

    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin main
        git reset --hard origin/main

    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true

    - name: Cleanup container & network conflicts
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker rm -f royalbakery-mysql-1 || true
        docker network rm royalbakery_default || true
        docker network rm royalbakery_app-network || true

    - name: Remove old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f

    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d

    - name: Wait for services to be ready
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        sleep 30
        docker compose ps

    - name: Health check
      run: |
        curl -f http://localhost:8080 || exit 1

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "✅ Deployment berhasil di laptop-najmira!"
        else
          echo "❌ Deployment gagal di laptop-najmira!"
        fi
